import json
import winreg
import os

abs_path = os.path.dirname(os.path.realpath(__file__))


def get_hkey(root_key):
    if root_key == "HKLM":
        return winreg.HKEY_LOCAL_MACHINE
    elif root_key == "HKCU":
        return winreg.HKEY_CURRENT_USER


def scan_regs():
    reg_json = open(abs_path + "\\data\\reg.json", "r")
    reg_load = json.load(reg_json)

    for _, v in reg_load.items():
        root_key = v["rootkey"]
        reg_key = v["regkey"]
        path = v["path"]
        full_path = f"{root_key}\\{path}"

        setting = get_hkey(root_key)

        try:
            winreg_key = winreg.OpenKeyEx(setting, path)
            winreg.QueryValueEx(winreg_key, reg_key)
            print(f"[Infected] {reg_key} |", full_path)
            winreg.CloseKey(winreg_key)
        except:
            pass


def scan_files():
    file_json = open(abs_path + "\\data\\file.json", "r")
    file_load = json.load(file_json)

    for k, v in file_load.items():
        file_path = v["path"]

        if os.path.exists(file_path):
            print(f"[Infected] {k} |", file_path)


def main():
    scan_regs()
    scan_files()
    print("\n[Completed]\n"
          "\n- DO NOT forget to check the TAG and MSTIC for more information\n"
          "- More advanced search such as \"Network\" \"Execution\" \"SHA-256\" can be done using Microsoft Defender for Endpoint\n"
          "\n- Feel free to open issue or contribute | github.com/Lutwidse/DOS2RCE-Malware-Scanner")


if __name__ == "__main__":
    main()
